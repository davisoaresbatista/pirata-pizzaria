// Schema para PRODUÇÃO - MySQL (Hostinger)
// Copie este conteúdo para schema.prisma antes do deploy

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String    @db.VarChar(255)
  email         String    @unique @db.VarChar(255)
  password      String    @db.VarChar(255)
  role          String    @default("ADMIN") @db.VarChar(20)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("users")
}

model Employee {
  id            String    @id @default(cuid())
  name          String    @db.VarChar(255)
  role          String    @db.VarChar(100)
  salary        Decimal   @default(0) @db.Decimal(10, 2)
  phone         String?   @db.VarChar(20)
  document      String?   @db.VarChar(20)
  hireDate      DateTime  @default(now())
  active        Boolean   @default(true)
  
  // Turno Almoço
  worksLunch         Boolean   @default(false)
  lunchPaymentType   String    @default("SHIFT") @db.VarChar(20)
  lunchValue         Decimal   @default(0) @db.Decimal(10, 2)
  lunchStartTime     String?   @db.VarChar(10)
  lunchEndTime       String?   @db.VarChar(10)
  
  // Turno Jantar
  worksDinner           Boolean   @default(false)
  dinnerPaymentType     String    @default("SHIFT") @db.VarChar(20)
  dinnerWeekdayValue    Decimal   @default(0) @db.Decimal(10, 2)
  dinnerWeekendValue    Decimal   @default(0) @db.Decimal(10, 2)
  dinnerStartTime       String?   @db.VarChar(10)
  dinnerEndTime         String?   @db.VarChar(10)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  advances       Advance[]
  payrollEntries PayrollEntry[]
  timeEntries    TimeEntry[]

  @@map("employees")
}

model TimeEntry {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  date          DateTime  @db.Date
  
  // Turnos trabalhados
  workedLunch   Boolean   @default(false)
  workedDinner  Boolean   @default(false)
  
  // Horários de entrada/saída - Almoço
  clockInLunch  String?   @db.VarChar(10)
  clockOutLunch String?   @db.VarChar(10)
  
  // Horários de entrada/saída - Jantar
  clockInDinner  String?  @db.VarChar(10)
  clockOutDinner String?  @db.VarChar(10)
  
  status        String    @default("PRESENT") @db.VarChar(20)
  notes         String?   @db.Text
  
  // Valores calculados
  lunchValue    Decimal   @default(0) @db.Decimal(10, 2)
  dinnerValue   Decimal   @default(0) @db.Decimal(10, 2)
  totalValue    Decimal   @default(0) @db.Decimal(10, 2)
  
  // Auditoria
  createdById   String?   @db.VarChar(50)
  updatedById   String?   @db.VarChar(50)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([employeeId, date])
  @@map("time_entries")
}

// Configuração de valores por turno
model ShiftConfig {
  id            String    @id @default(cuid())
  name          String    @unique @db.VarChar(50)
  description   String    @db.VarChar(255)
  value         Decimal   @db.Decimal(10, 2)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("shift_configs")
}

// Fechamento de período
model PayrollPeriod {
  id            String    @id @default(cuid())
  startDate     DateTime  @db.Date
  endDate       DateTime  @db.Date
  periodType    String    @db.VarChar(20)
  status        String    @default("OPEN") @db.VarChar(20)
  totalAmount   Decimal   @default(0) @db.Decimal(10, 2)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  payments      PayrollPayment[]

  @@map("payroll_periods")
}

// Pagamentos do período
model PayrollPayment {
  id              String    @id @default(cuid())
  periodId        String
  period          PayrollPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  employeeId      String    @db.VarChar(50)
  employeeName    String    @db.VarChar(255)
  
  // Detalhamento
  daysWorked      Int       @default(0)
  lunchShifts     Int       @default(0)
  dinnerShifts    Int       @default(0)
  
  // Valores
  fixedSalary     Decimal   @default(0) @db.Decimal(10, 2)
  lunchTotal      Decimal   @default(0) @db.Decimal(10, 2)
  dinnerTotal     Decimal   @default(0) @db.Decimal(10, 2)
  grossAmount     Decimal   @default(0) @db.Decimal(10, 2)
  advances        Decimal   @default(0) @db.Decimal(10, 2)
  deductions      Decimal   @default(0) @db.Decimal(10, 2)
  netAmount       Decimal   @default(0) @db.Decimal(10, 2)
  
  paid            Boolean   @default(false)
  paidAt          DateTime?
  notes           String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("payroll_payments")
}

model Advance {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  amount        Decimal   @db.Decimal(10, 2)
  requestDate   DateTime  @default(now())
  paymentDate   DateTime?
  status        String    @default("PENDING") @db.VarChar(20)
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("advances")
}

model PayrollEntry {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  month         String    @db.VarChar(7)
  baseSalary    Decimal   @db.Decimal(10, 2)
  advances      Decimal   @db.Decimal(10, 2) @default(0)
  bonuses       Decimal   @db.Decimal(10, 2) @default(0)
  deductions    Decimal   @db.Decimal(10, 2) @default(0)
  netSalary     Decimal   @db.Decimal(10, 2)
  paymentDate   DateTime?
  paid          Boolean   @default(false)
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([employeeId, month])
  @@map("payroll_entries")
}

model Expense {
  id            String    @id @default(cuid())
  category      String    @db.VarChar(50)
  description   String    @db.VarChar(255)
  amount        Decimal   @db.Decimal(10, 2)
  date          DateTime
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("expenses")
}

model Revenue {
  id            String    @id @default(cuid())
  source        String    @db.VarChar(50)
  description   String?   @db.VarChar(255)
  amount        Decimal   @db.Decimal(10, 2)
  date          DateTime
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("revenues")
}

// ============================================================================
// VENDAS (Consumer Connect)
// ============================================================================

// Pedidos/Comandas do sistema Consumer Connect
model SalesOrder {
  id              String    @id @default(cuid())
  externalId      String    @unique @db.VarChar(50)    // Cód do Consumer Connect
  origin          String    @db.VarChar(100)           // Origem: "Comanda Mobile", etc.
  orderType       String    @db.VarChar(100)           // Tipo: "Balcão", "Mesas/Comandas 3"
  itemsCount      Int       @default(0)
  amount          Decimal   @db.Decimal(10, 2)
  status          String    @db.VarChar(50)            // "Finalizado Pago", etc.
  paymentStatus   String    @default("PAID") @db.VarChar(20)  // PAID, PENDING, CANCELLED
  openedAt        DateTime
  closedAt        DateTime?
  duration        Int?                                  // Duração em segundos
  unit            String    @default("PIRATA PIZZARIA") @db.VarChar(100)
  
  // Detalhes de pagamento
  paymentMethod   String?   @db.VarChar(50)
  
  // Metadados
  tableNumber     Int?
  isDelivery      Boolean   @default(false)
  isCounter       Boolean   @default(false)
  
  // Auditoria
  syncedAt        DateTime  @default(now())
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([openedAt])
  @@index([status])
  @@index([orderType])
  @@index([paymentStatus])
  @@map("sales_orders")
}

// Tabela para dados de calendário e eventos especiais
model CalendarEvent {
  id              String    @id @default(cuid())
  name            String    @db.VarChar(100)           // Nome do evento
  date            DateTime
  eventType       String    @db.VarChar(50)            // HOLIDAY, SEASONAL, SPECIAL, LOCAL
  scope           String    @default("NATIONAL") @db.VarChar(20) // NATIONAL, STATE, MUNICIPAL
  description     String?   @db.VarChar(500)
  impactExpected  String?   @db.VarChar(20)            // HIGH, MEDIUM, LOW
  recurring       Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([date, name])
  @@index([date])
  @@index([eventType])
  @@index([scope])
  @@map("calendar_events")
}

// Dados meteorológicos diários
model WeatherData {
  id              String    @id @default(cuid())
  date            DateTime  @unique @db.Date
  
  tempMin         Float
  tempMax         Float
  tempAvg         Float
  feelsLikeAvg    Float?
  
  precipitation   Float     @default(0)
  humidity        Float?
  
  condition       String?   @db.VarChar(100)
  conditionCode   Int?
  
  windSpeed       Float?
  windDirection   String?   @db.VarChar(10)
  
  uvIndex         Float?
  visibility      Float?
  
  source          String    @default("OPEN_METEO") @db.VarChar(50)
  city            String    @default("Bertioga") @db.VarChar(100)
  state           String    @default("SP") @db.VarChar(2)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([date])
  @@map("weather_data")
}

// Cache de features calculadas para ML
model DailyFeatures {
  id              String    @id @default(cuid())
  date            DateTime  @unique @db.Date

  totalOrders     Int       @default(0)
  totalRevenue    Float     @default(0)
  avgTicket       Float     @default(0)
  totalItems      Int       @default(0)
  
  avgDuration     Int       @default(0)
  
  counterOrders   Int       @default(0)
  tableOrders     Int       @default(0)
  deliveryOrders  Int       @default(0)
  
  paidOrders      Int       @default(0)
  pendingOrders   Int       @default(0)
  
  isWeekend       Boolean   @default(false)
  isHoliday       Boolean   @default(false)
  holidayName     String?   @db.VarChar(100)
  holidayScope    String?   @db.VarChar(20)
  dayOfWeek       Int
  dayOfMonth      Int
  month           Int
  year            Int
  
  tempMin         Float?
  tempMax         Float?
  tempAvg         Float?
  precipitation   Float?
  condition       String?   @db.VarChar(100)
  
  nextDayOrders   Int?
  nextDayRevenue  Float?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([date])
  @@index([isWeekend])
  @@index([isHoliday])
  @@map("daily_features")
}

// Previsões geradas pelo modelo
model Prediction {
  id              String    @id @default(cuid())
  date            DateTime  @db.Date
  modelVersion    String    @db.VarChar(50)
  
  predictedOrders     Float
  predictedRevenue    Float
  
  ordersLower         Float?
  ordersUpper         Float?
  revenueLower        Float?
  revenueUpper        Float?
  
  confidence          Float?
  
  actualOrders        Int?
  actualRevenue       Float?
  
  features            String?   @db.Text
  createdAt           DateTime  @default(now())

  @@unique([date, modelVersion])
  @@index([date])
  @@map("predictions")
}

// Cache de métricas calculadas para performance
model SalesMetrics {
  id              String    @id @default(cuid())
  date            DateTime
  periodType      String    @db.VarChar(20)            // DAILY, WEEKLY, MONTHLY
  
  // Métricas de vendas
  totalOrders     Int       @default(0)
  totalAmount     Decimal   @default(0) @db.Decimal(10, 2)
  avgOrderValue   Decimal   @default(0) @db.Decimal(10, 2)
  totalItems      Int       @default(0)
  
  // Métricas por tipo
  counterOrders   Int       @default(0)
  tableOrders     Int       @default(0)
  deliveryOrders  Int       @default(0)
  
  // Métricas de tempo
  avgDuration     Int       @default(0)
  
  // Métricas de pagamento
  paidOrders      Int       @default(0)
  pendingOrders   Int       @default(0)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([date, periodType])
  @@map("sales_metrics")
}

// ============================================================================
// SEGURANÇA E AUDITORIA
// ============================================================================

model AuditLog {
  id            String    @id @default(cuid())
  userId        String    @db.VarChar(50)
  userEmail     String    @db.VarChar(255)
  action        String    @db.VarChar(50)
  resource      String    @db.VarChar(255)
  resourceId    String?   @db.VarChar(50)
  details       String?   @db.Text
  ipAddress     String    @db.VarChar(45)
  userAgent     String    @db.Text
  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// Tentativas de login (para proteção contra força bruta)
model LoginAttempt {
  id            String    @id @default(cuid())
  email         String    @db.VarChar(255)
  ipAddress     String    @db.VarChar(45)
  success       Boolean
  userAgent     String?   @db.Text
  createdAt     DateTime  @default(now())

  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
  @@map("login_attempts")
}

// ============================================================================
// CARDÁPIO
// ============================================================================

// Categorias do cardápio
model MenuCategory {
  id            String    @id @default(cuid())
  name          String    @unique @db.VarChar(50)
  displayName   String    @db.VarChar(100)
  description   String?   @db.VarChar(500)
  icon          String?   @db.VarChar(50)
  shift         String    @default("both") @db.VarChar(20)  // "lunch", "dinner", "both"
  order         Int       @default(0)
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  items         MenuItem[]

  @@map("menu_categories")
}

// Itens do cardápio
model MenuItem {
  id            String    @id @default(cuid())
  categoryId    String
  category      MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  name          String    @db.VarChar(100)
  description   String?   @db.VarChar(500)
  price         Decimal   @db.Decimal(10, 2)
  
  active        Boolean   @default(true)
  featured      Boolean   @default(false)
  popular       Boolean   @default(false)
  spicy         Boolean   @default(false)
  vegetarian    Boolean   @default(false)
  newItem       Boolean   @default(false)
  
  imageUrl      String?   @db.VarChar(500)
  order         Int       @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("menu_items")
}
