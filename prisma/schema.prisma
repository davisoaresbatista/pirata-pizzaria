// Schema para desenvolvimento local (SQLite)
// Para produção MySQL, copie schema.mysql.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String
  role          String    @default("ADMIN")  // ADMIN, MANAGER
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("users")
}

model Employee {
  id            String    @id @default(cuid())
  name          String
  role          String
  salary        Decimal   @default(0)  // Salário fixo (se aplicável)
  phone         String?
  document      String?
  hireDate      DateTime  @default(now())
  active        Boolean   @default(true)
  
  // Turno Almoço
  worksLunch         Boolean   @default(false)
  lunchPaymentType   String    @default("SHIFT")  // Tipo pagamento do almoço: HOUR, SHIFT, DAY
  lunchValue         Decimal   @default(0)        // Valor (hora/turno/dia)
  lunchStartTime     String?                      // Horário entrada
  lunchEndTime       String?                      // Horário saída
  
  // Turno Jantar
  worksDinner           Boolean   @default(false)
  dinnerPaymentType     String    @default("SHIFT")  // Tipo pagamento do jantar: HOUR, SHIFT, DAY
  dinnerWeekdayValue    Decimal   @default(0)        // Valor seg-sex
  dinnerWeekendValue    Decimal   @default(0)        // Valor sáb-dom
  dinnerStartTime       String?                      // Horário entrada
  dinnerEndTime         String?                      // Horário saída
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  advances       Advance[]
  payrollEntries PayrollEntry[]
  timeEntries    TimeEntry[]

  @@map("employees")
}

model TimeEntry {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  date          DateTime
  
  // Turnos trabalhados
  workedLunch   Boolean   @default(false)  // Trabalhou no almoço
  workedDinner  Boolean   @default(false)  // Trabalhou no jantar
  
  // Horários de entrada/saída - Almoço
  clockInLunch  String?   // Formato HH:MM
  clockOutLunch String?   // Formato HH:MM
  
  // Horários de entrada/saída - Jantar
  clockInDinner  String?  // Formato HH:MM
  clockOutDinner String?  // Formato HH:MM
  
  status        String    @default("PRESENT") // PRESENT, ABSENT, LATE, HALF_DAY
  notes         String?
  
  // Valores calculados
  lunchValue    Decimal   @default(0)
  dinnerValue   Decimal   @default(0)
  totalValue    Decimal   @default(0)
  
  // Auditoria
  createdById   String?   // ID do usuário que criou
  updatedById   String?   // ID do usuário que atualizou
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([employeeId, date])
  @@map("time_entries")
}

// Configuração de valores por turno
model ShiftConfig {
  id            String    @id @default(cuid())
  name          String    @unique  // Ex: "lunch", "dinner_weekday", "dinner_weekend"
  description   String
  value         Decimal
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("shift_configs")
}

// Fechamento de período
model PayrollPeriod {
  id            String    @id @default(cuid())
  startDate     DateTime
  endDate       DateTime
  periodType    String    // WEEKLY, BIWEEKLY, MONTHLY
  status        String    @default("OPEN") // OPEN, CLOSED
  totalAmount   Decimal   @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  payments      PayrollPayment[]

  @@map("payroll_periods")
}

// Pagamentos do período
model PayrollPayment {
  id              String    @id @default(cuid())
  periodId        String
  period          PayrollPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  employeeId      String
  employeeName    String
  
  // Detalhamento
  daysWorked      Int       @default(0)
  lunchShifts     Int       @default(0)
  dinnerShifts    Int       @default(0)
  
  // Valores
  fixedSalary     Decimal   @default(0)
  lunchTotal      Decimal   @default(0)
  dinnerTotal     Decimal   @default(0)
  grossAmount     Decimal   @default(0)
  advances        Decimal   @default(0)
  deductions      Decimal   @default(0)
  netAmount       Decimal   @default(0)
  
  paid            Boolean   @default(false)
  paidAt          DateTime?
  notes           String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("payroll_payments")
}

model Advance {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  amount        Decimal
  requestDate   DateTime  @default(now())
  paymentDate   DateTime?
  status        String    @default("PENDING")
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("advances")
}

model PayrollEntry {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  month         String
  baseSalary    Decimal
  advances      Decimal   @default(0)
  bonuses       Decimal   @default(0)
  deductions    Decimal   @default(0)
  netSalary     Decimal
  paymentDate   DateTime?
  paid          Boolean   @default(false)
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([employeeId, month])
  @@map("payroll_entries")
}

model Expense {
  id            String    @id @default(cuid())
  category      String
  description   String
  amount        Decimal
  date          DateTime
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("expenses")
}

model Revenue {
  id            String    @id @default(cuid())
  source        String
  description   String?
  amount        Decimal
  date          DateTime
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("revenues")
}

// ============================================================================
// SEGURANÇA E AUDITORIA
// ============================================================================

model AuditLog {
  id            String    @id @default(cuid())
  userId        String                          // ID do usuário que executou a ação
  userEmail     String                          // Email para referência rápida
  action        String                          // CREATE, UPDATE, DELETE, LOGIN, ACCESS_DENIED, etc.
  resource      String                          // Recurso afetado (ex: /api/employees)
  resourceId    String?                         // ID do recurso específico (opcional)
  details       String?                         // JSON com detalhes adicionais
  ipAddress     String                          // IP do cliente
  userAgent     String                          // User agent do navegador
  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// Tentativas de login (para proteção contra força bruta)
model LoginAttempt {
  id            String    @id @default(cuid())
  email         String                          // Email tentado
  ipAddress     String                          // IP da tentativa
  success       Boolean                         // Se o login foi bem-sucedido
  userAgent     String?                         // User agent
  createdAt     DateTime  @default(now())

  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
  @@map("login_attempts")
}

// ============================================================================
// CARDÁPIO
// ============================================================================

// Categorias do cardápio
model MenuCategory {
  id            String    @id @default(cuid())
  name          String    @unique               // Ex: "pizzas_salgadas", "pizzas_doces", "almoco", etc.
  displayName   String                          // Ex: "Pizzas Salgadas"
  description   String?
  icon          String?                         // Nome do ícone (ex: "Pizza", "Cake", "Utensils")
  order         Int       @default(0)           // Ordem de exibição
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  items         MenuItem[]

  @@map("menu_categories")
}

// Itens do cardápio
model MenuItem {
  id            String    @id @default(cuid())
  categoryId    String
  category      MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  name          String                          // Nome do prato/pizza
  description   String?                         // Ingredientes/descrição
  price         Decimal                         // Preço
  
  // Flags especiais
  active        Boolean   @default(true)        // Se está disponível
  featured      Boolean   @default(false)       // Destaque (estrela)
  popular       Boolean   @default(false)       // Popular (fogo)
  spicy         Boolean   @default(false)       // Picante
  vegetarian    Boolean   @default(false)       // Vegetariano
  newItem       Boolean   @default(false)       // Novidade
  
  // Imagem (opcional)
  imageUrl      String?
  
  // Ordem de exibição dentro da categoria
  order         Int       @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("menu_items")
}
