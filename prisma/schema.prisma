// Schema para desenvolvimento local (SQLite)
// Para produção MySQL, copie schema.mysql.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String
  role          String    @default("ADMIN")  // ADMIN, MANAGER
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("users")
}

model Employee {
  id            String    @id @default(cuid())
  name          String
  role          String
  salary        Decimal   @default(0)  // Salário fixo (se aplicável)
  phone         String?
  document      String?
  hireDate      DateTime  @default(now())
  active        Boolean   @default(true)
  
  // Turno Almoço
  worksLunch         Boolean   @default(false)
  lunchPaymentType   String    @default("SHIFT")  // Tipo pagamento do almoço: HOUR, SHIFT, DAY
  lunchValue         Decimal   @default(0)        // Valor (hora/turno/dia)
  lunchStartTime     String?                      // Horário entrada
  lunchEndTime       String?                      // Horário saída
  
  // Turno Jantar
  worksDinner           Boolean   @default(false)
  dinnerPaymentType     String    @default("SHIFT")  // Tipo pagamento do jantar: HOUR, SHIFT, DAY
  dinnerWeekdayValue    Decimal   @default(0)        // Valor seg-sex
  dinnerWeekendValue    Decimal   @default(0)        // Valor sáb-dom
  dinnerStartTime       String?                      // Horário entrada
  dinnerEndTime         String?                      // Horário saída
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  advances       Advance[]
  payrollEntries PayrollEntry[]
  timeEntries    TimeEntry[]

  @@map("employees")
}

model TimeEntry {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  date          DateTime
  
  // Turnos trabalhados
  workedLunch   Boolean   @default(false)  // Trabalhou no almoço
  workedDinner  Boolean   @default(false)  // Trabalhou no jantar
  
  // Horários de entrada/saída - Almoço
  clockInLunch  String?   // Formato HH:MM
  clockOutLunch String?   // Formato HH:MM
  
  // Horários de entrada/saída - Jantar
  clockInDinner  String?  // Formato HH:MM
  clockOutDinner String?  // Formato HH:MM
  
  status        String    @default("PRESENT") // PRESENT, ABSENT, LATE, HALF_DAY
  notes         String?
  
  // Valores calculados
  lunchValue    Decimal   @default(0)
  dinnerValue   Decimal   @default(0)
  totalValue    Decimal   @default(0)
  
  // Auditoria
  createdById   String?   // ID do usuário que criou
  updatedById   String?   // ID do usuário que atualizou
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([employeeId, date])
  @@map("time_entries")
}

// Configuração de valores por turno
model ShiftConfig {
  id            String    @id @default(cuid())
  name          String    @unique  // Ex: "lunch", "dinner_weekday", "dinner_weekend"
  description   String
  value         Decimal
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("shift_configs")
}

// Fechamento de período
model PayrollPeriod {
  id            String    @id @default(cuid())
  startDate     DateTime
  endDate       DateTime
  periodType    String    // WEEKLY, BIWEEKLY, MONTHLY
  status        String    @default("OPEN") // OPEN, CLOSED
  totalAmount   Decimal   @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  payments      PayrollPayment[]

  @@map("payroll_periods")
}

// Pagamentos do período
model PayrollPayment {
  id              String    @id @default(cuid())
  periodId        String
  period          PayrollPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  employeeId      String
  employeeName    String
  
  // Detalhamento
  daysWorked      Int       @default(0)
  lunchShifts     Int       @default(0)
  dinnerShifts    Int       @default(0)
  
  // Valores
  fixedSalary     Decimal   @default(0)
  lunchTotal      Decimal   @default(0)
  dinnerTotal     Decimal   @default(0)
  grossAmount     Decimal   @default(0)
  advances        Decimal   @default(0)
  deductions      Decimal   @default(0)
  netAmount       Decimal   @default(0)
  
  paid            Boolean   @default(false)
  paidAt          DateTime?
  notes           String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("payroll_payments")
}

model Advance {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  amount        Decimal
  requestDate   DateTime  @default(now())
  paymentDate   DateTime?
  status        String    @default("PENDING")
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("advances")
}

model PayrollEntry {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  month         String
  baseSalary    Decimal
  advances      Decimal   @default(0)
  bonuses       Decimal   @default(0)
  deductions    Decimal   @default(0)
  netSalary     Decimal
  paymentDate   DateTime?
  paid          Boolean   @default(false)
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([employeeId, month])
  @@map("payroll_entries")
}

model Expense {
  id            String    @id @default(cuid())
  category      String
  description   String
  amount        Decimal
  date          DateTime
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("expenses")
}

model Revenue {
  id            String    @id @default(cuid())
  source        String
  description   String?
  amount        Decimal
  date          DateTime
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("revenues")
}

// ============================================================================
// VENDAS (Consumer Connect)
// ============================================================================

// Pedidos/Comandas do sistema Consumer Connect
model SalesOrder {
  id              String    @id @default(cuid())
  externalId      String    @unique           // Cód do Consumer Connect (185586, etc.)
  origin          String                       // Origem: "Comanda Mobile", "PDV", etc.
  orderType       String                       // Tipo: "Balcão", "Mesas/Comandas 3", etc.
  itemsCount      Int       @default(0)        // Quantidade de itens
  amount          Decimal                      // Valor Final
  status          String                       // Status: "Finalizado Pago", "Finalizado Fiado", "Cancelado"
  paymentStatus   String    @default("PAID")   // PAID, PENDING, CANCELLED
  openedAt        DateTime                     // Data/hora de abertura
  closedAt        DateTime?                    // Data/hora de fechamento
  duration        Int?                         // Duração em segundos
  unit            String    @default("PIRATA PIZZARIA")  // Unidade/loja
  
  // Detalhes de pagamento
  paymentMethod   String?                      // PIX, CREDITO, DEBITO, DINHEIRO, etc.
  
  // Metadados
  tableNumber     Int?                         // Número da mesa (extraído do tipo)
  isDelivery      Boolean   @default(false)    // Se é delivery
  isCounter       Boolean   @default(false)    // Se é balcão
  
  // Auditoria
  syncedAt        DateTime  @default(now())    // Quando foi sincronizado
  deletedAt       DateTime?                    // Soft delete
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([openedAt])
  @@index([status])
  @@index([orderType])
  @@index([paymentStatus])
  @@map("sales_orders")
}

// Tabela para dados de calendário e eventos especiais
model CalendarEvent {
  id              String    @id @default(cuid())
  name            String                       // Nome do evento (Dia das Mães, Carnaval, etc.)
  date            DateTime                     // Data do evento
  eventType       String                       // HOLIDAY, SEASONAL, SPECIAL, LOCAL
  scope           String    @default("NATIONAL") // NATIONAL, STATE, MUNICIPAL, COMMERCIAL
  description     String?                      // Descrição adicional
  impactExpected  String?                      // HIGH, MEDIUM, LOW - impacto esperado nas vendas
  recurring       Boolean   @default(false)    // Se é recorrente anualmente
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([date, name])
  @@index([date])
  @@index([eventType])
  @@index([scope])
  @@map("calendar_events")
}

// Dados meteorológicos diários
model WeatherData {
  id              String    @id @default(cuid())
  date            DateTime  @unique            // Data (apenas dia, sem hora)
  
  // Temperaturas em Celsius
  tempMin         Float                        // Temperatura mínima
  tempMax         Float                        // Temperatura máxima
  tempAvg         Float                        // Temperatura média
  feelsLikeAvg    Float?                       // Sensação térmica média
  
  // Precipitação
  precipitation   Float     @default(0)        // Precipitação total (mm)
  humidity        Float?                       // Umidade relativa média (%)
  
  // Condições
  condition       String?                      // Ensolarado, Nublado, Chuvoso, etc.
  conditionCode   Int?                         // Código da condição (API)
  
  // Vento
  windSpeed       Float?                       // Velocidade do vento (km/h)
  windDirection   String?                      // Direção do vento
  
  // UV e visibilidade
  uvIndex         Float?                       // Índice UV
  visibility      Float?                       // Visibilidade (km)
  
  // Metadados
  source          String    @default("OPEN_METEO") // Fonte dos dados
  city            String    @default("Bertioga")
  state           String    @default("SP")
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([date])
  @@map("weather_data")
}

// Cache de features calculadas para ML
model DailyFeatures {
  id              String    @id @default(cuid())
  date            DateTime  @unique            // Data

  // Features de vendas
  totalOrders     Int       @default(0)
  totalRevenue    Float     @default(0)
  avgTicket       Float     @default(0)
  totalItems      Int       @default(0)
  
  // Features de tempo
  avgDuration     Int       @default(0)        // Duração média em segundos
  
  // Features por tipo
  counterOrders   Int       @default(0)
  tableOrders     Int       @default(0)
  deliveryOrders  Int       @default(0)
  
  // Features de pagamento
  paidOrders      Int       @default(0)
  pendingOrders   Int       @default(0)
  
  // Features de calendário
  isWeekend       Boolean   @default(false)
  isHoliday       Boolean   @default(false)
  holidayName     String?
  holidayScope    String?                      // NATIONAL, STATE, MUNICIPAL
  dayOfWeek       Int                          // 0=Dom, 6=Sáb
  dayOfMonth      Int
  month           Int
  year            Int
  
  // Features meteorológicas
  tempMin         Float?
  tempMax         Float?
  tempAvg         Float?
  precipitation   Float?
  condition       String?
  
  // Target para ML (pode ser preenchido depois)
  nextDayOrders   Int?                         // Pedidos do dia seguinte (para previsão)
  nextDayRevenue  Float?                       // Receita do dia seguinte
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([date])
  @@index([isWeekend])
  @@index([isHoliday])
  @@map("daily_features")
}

// Previsões geradas pelo modelo
model Prediction {
  id              String    @id @default(cuid())
  date            DateTime                     // Data da previsão
  modelVersion    String                       // Versão do modelo usado
  
  // Previsões
  predictedOrders     Float                    // Pedidos previstos
  predictedRevenue    Float                    // Receita prevista
  
  // Intervalos de confiança
  ordersLower         Float?                   // Limite inferior (95%)
  ordersUpper         Float?                   // Limite superior (95%)
  revenueLower        Float?
  revenueUpper        Float?
  
  // Métricas do modelo
  confidence          Float?                   // Confiança da previsão (0-1)
  
  // Valores reais (preenchido depois para avaliar)
  actualOrders        Int?
  actualRevenue       Float?
  
  // Metadados
  features            String?                  // JSON com features usadas
  createdAt           DateTime  @default(now())

  @@unique([date, modelVersion])
  @@index([date])
  @@map("predictions")
}

// Cache de métricas calculadas para performance
model SalesMetrics {
  id              String    @id @default(cuid())
  date            DateTime                     // Data da métrica
  periodType      String                       // DAILY, WEEKLY, MONTHLY
  
  // Métricas de vendas
  totalOrders     Int       @default(0)
  totalAmount     Decimal   @default(0)
  avgOrderValue   Decimal   @default(0)
  totalItems      Int       @default(0)
  
  // Métricas por tipo
  counterOrders   Int       @default(0)
  tableOrders     Int       @default(0)
  deliveryOrders  Int       @default(0)
  
  // Métricas de tempo
  avgDuration     Int       @default(0)        // Segundos
  
  // Métricas de pagamento
  paidOrders      Int       @default(0)
  pendingOrders   Int       @default(0)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([date, periodType])
  @@map("sales_metrics")
}

// ============================================================================
// SEGURANÇA E AUDITORIA
// ============================================================================

model AuditLog {
  id            String    @id @default(cuid())
  userId        String                          // ID do usuário que executou a ação
  userEmail     String                          // Email para referência rápida
  action        String                          // CREATE, UPDATE, DELETE, LOGIN, ACCESS_DENIED, etc.
  resource      String                          // Recurso afetado (ex: /api/employees)
  resourceId    String?                         // ID do recurso específico (opcional)
  details       String?                         // JSON com detalhes adicionais
  ipAddress     String                          // IP do cliente
  userAgent     String                          // User agent do navegador
  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// Tentativas de login (para proteção contra força bruta)
model LoginAttempt {
  id            String    @id @default(cuid())
  email         String                          // Email tentado
  ipAddress     String                          // IP da tentativa
  success       Boolean                         // Se o login foi bem-sucedido
  userAgent     String?                         // User agent
  createdAt     DateTime  @default(now())

  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
  @@map("login_attempts")
}

// ============================================================================
// CARDÁPIO
// ============================================================================

// Categorias do cardápio
model MenuCategory {
  id            String    @id @default(cuid())
  name          String    @unique               // Ex: "pizzas_salgadas", "pizzas_doces", "almoco", etc.
  displayName   String                          // Ex: "Pizzas Salgadas"
  description   String?
  icon          String?                         // Nome do ícone (ex: "Pizza", "Cake", "Utensils")
  shift         String    @default("both")      // "lunch" (almoço), "dinner" (pizzaria), "both" (ambos)
  order         Int       @default(0)           // Ordem de exibição
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  items         MenuItem[]

  @@map("menu_categories")
}

// Itens do cardápio
model MenuItem {
  id            String    @id @default(cuid())
  categoryId    String
  category      MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  name          String                          // Nome do prato/pizza
  description   String?                         // Ingredientes/descrição
  price         Decimal                         // Preço
  
  // Flags especiais
  active        Boolean   @default(true)        // Se está disponível
  featured      Boolean   @default(false)       // Destaque (estrela)
  popular       Boolean   @default(false)       // Popular (fogo)
  spicy         Boolean   @default(false)       // Picante
  vegetarian    Boolean   @default(false)       // Vegetariano
  newItem       Boolean   @default(false)       // Novidade
  
  // Imagem (opcional)
  imageUrl      String?
  
  // Ordem de exibição dentro da categoria
  order         Int       @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("menu_items")
}
